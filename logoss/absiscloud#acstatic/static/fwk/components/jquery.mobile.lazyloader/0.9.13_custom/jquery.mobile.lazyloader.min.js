(function($,undefined){$.widget("mobile.lazyloader",$.mobile.widget,{_defaultOptions:{'threshold':$(window).height(),'retrieve':20,'retrieved':20,'bubbles':false,'offset':0},_defaultParameters:{'retrieve':20,'retrieved':20,'offset':0},_defaultSettings:{"pageId":"","templateType":"","templatePrecompiled":false,"templateId":"","template":"","mainId":"","progressDivId":"","moreUrl":"","clearUrl":"","JSONP":false,"JSONPCallback":""},_defaultSelectors:{"main":'ul',"single":'ul li',"bottom":'[data-role="list-divider"]'},_handleScrollStartJustFired:false,_handleScrollStopJustFired:false,_mouseWheelEventJustFired:false,_handleScrollStartTimeoutId:null,_handleScrollStopTimeoutId:null,_mouseWheelTimeoutId:null,_instances:{},_moreOutstandingPageId:null,_parameters:null,_settings:null,_selectors:null,timeoutOptions:{'mousewheel':350,'scrollstart':500,'scrollstop':50,'showprogress':200,'scrolldown':400,'immediately':0},_widgetName:"lazyloader",_widgetState:{'busy':false,'done':false},_create:function(){this._initialize(this._defaultOptions,this._defaultSettings,this._defaultParameters,this._defaultSelectors);this._bind()},_init:function(){},_initialize:function(options,settings,parameters,selectors){if((typeof options!='undefined')&&(options!='')){this._widgetState.busy=false;this._widgetState.done=false;this._settings=$.extend(true,this._settings,this._defaultSettings);this._settings=$.extend(true,this._settings,settings);if((typeof this._settings.mainId!=='undefined')&&(this._settings.mainId!=="")){this._defaultSelectors.main='#'+this._settings.mainId;this._defaultSelectors.single='#'+this._settings.mainId+' li';this._defaultSelectors.bottom='[data-role="list-divider"]'}if((typeof this._settings.pageId!=='undefined')&&(this._settings.pageId!=="")){this._settings.totalHeight=$("#"+this._settings.pageId).height()}this._selectors=$.extend(true,this._selectors,this._defaultSelectors);this._selectors=$.extend(true,this._selectors,selectors);this._parameters=$.extend(true,this._parameters,this._defaultParameters);this._parameters=$.extend(true,this._parameters,parameters);this.options=$.extend(true,this.options,this._defaultOptions);this.options=$.extend(true,this.options,options);var newPageId=settings.pageId;if((typeof newPageId!='undefined ')&&(newPageId!='')){if(!this._instances[newPageId]){if((typeof this._settings.template=='undefined')||(this._settings.template=='')){if((typeof this._settings.templateId!='undefined')&&(this._settings.templateId!='')){var template=$("#"+this._settings.templateId).html();var templateType="";var templatePrecompiled=this._settings.templatePrecompiled;if((typeof this._settings.templateType!='undefined')&&(this._settings.templateType!='')){templateType=this._settings.templateType}if((templateType==="dust")&&(template!=="")&&(!templatePrecompiled)){this._settings.template=dust.compile(template,this._settings.templateId)}else{this._settings.template=template}}}this._instances[newPageId]=[];this._instances[newPageId]['options']=$.extend(true,{},this.options);this._instances[newPageId]['settings']=$.extend(true,{},this._settings);this._instances[newPageId]['selectors']=$.extend(true,{},this._selectors)}}}},_bind:function(){$(window).bind("scrollstart",$.proxy(this._handleScrollStart,this));$(window).bind("scrollstop",$.proxy(this._handleScrollStop,this));if(/Firefox/i.test(navigator.userAgent)){$(window).bind("DOMMouseScroll",$.proxy(this._handleMouseWheelEvent,this))}else{if((typeof this._selectors!='undefined')&&(this._selectors!=null)&&(this._selectors!='')){if(typeof this._selectors.main!='undefined'){if($(this._selectors.main).attachEvent){$(window).bind("onmousewheel",$.proxy(this._handleMouseWheelEvent,this))}else{$(window).bind("mousewheel",$.proxy(this._handleMouseWheelEvent,this))}}}}},_unbind:function(){$(window).unbind("scrollstart",this._handleScrollStart);$(window).unbind("scrollstop",this._handleScrollStop);if(/Firefox/i.test(navigator.userAgent)){$(window).unbind("DOMMouseScroll",this._handleMouseWheelEvent)}else{if((typeof this._selectors!='undefined')&&(this._selectors!=null)&&(this._selectors!='')){if(typeof this._selectors.main!='undefined'){if($(this._selectors.main).attachEvent){$(window).unbind("onmousewheel",this._handleMouseWheelEvent)}else{$(window).unbind("mousewheel",this._handleMouseWheelEvent)}}}}},destroy:function(){this._unbind();this.options=null;this.timeoutOptions=null;this._settings=null;this._parameters=null;this._instances=null;this._handleScrollStartJustFired=null;this._handleScrollStopJustFired=null;this._mouseWheelEventJustFired=null;this._handleScrollStartTimeoutId=null;this._handleScrollStopTimeoutId=null;this._mouseWheelTimeoutId=null;this._widgetState=null;this._defaultOptions=null;this._defaultSettings=null;this._defaultParameters=null;$.Widget.prototype.destroy.apply(this)},_check:function(threshold){threshold=this.options.threshold||threshold;var totalHeight,singleItemHeight,currentScroll,visibleHeight;if(document.documentElement.scrollTop){currentScroll=document.documentElement.scrollTop}else{currentScroll=document.body.scrollTop}if(this._instances[this._settings.pageId]){totalHeight=this._instances[this._settings.pageId]['settings'].totalHeight;singleItemHeight=this._instances[this._settings.pageId]['settings'].singleItemHeight}else{totalHeight=this._settings.totalHeight;singleItemHeight=this._settings.singleItemHeight}visibleHeight=$(window).height();return((totalHeight-threshold)<=(currentScroll+visibleHeight))},_load:function(timeout){if((typeof this._settings.pageId!=undefined)&&(this._settings.pageId!='')){if($('.ui-page-active').attr('id')==this._settings.pageId){if((!this._widgetState.busy)&&(!this._widgetState.done)){this._moreOutstandingPageId=this._settings.pageId;$that=this;setTimeout(function(){if($that._moreOutstandingPageId==$that._settings.pageId){if($that._check($that.options.threshold)||(timeout===0)){$("#"+$that._settings.progressDivId).show($that.timeoutOptions.showprogress,function(){moreUrl=$that._settings.moreUrl;var requestType="POST";var dataType="json";var postData="";var JSONP=false;var JSONPCallback="";var count=0;if($that._instances[$that._settings.pageId]){$that._parameters.retrieve=$that._instances[$that._settings.pageId]['options'].retrieve;$that._parameters.retrieved=$that._instances[$that._settings.pageId]['options'].retrieved;$that._parameters.offset=$that._instances[$that._settings.pageId]['options'].offset;if(($that._instances[$that._settings.pageId]['settings'].JSONP)){JSONP=true;JSONPCallback=$that._instances[$that._settings.pageId]['settings'].JSONPCallback}}else{$that._parameters.retrieve=$that.options.retrieve;$that._parameters.retrieved=$that.options.retrieved;$that._parameters.offset=$that.options.offset}if((typeof $that._settings.pageId!='undefined')&&($that._settings.pageId!='')){var hidden_inputs=$("#"+$that._settings.pageId).find('[type="hidden"]');for(i=0;i<hidden_inputs.length;i++){var hidden_input=$(hidden_inputs).get(i);if((typeof $(hidden_input).attr('id')!='undefined')&&($(hidden_input).attr('id')!='')){$that._parameters[$(hidden_input).attr('id')]=escape($(hidden_input).val())}}}if(!JSONP){for(var key in $that._parameters){if(count==0){postData+=(key+"="+$that._parameters[key])}else{postData+=("&"+key+"="+$that._parameters[key])}count=count+1}}else{requestType="GET";dataType="jsonp";var JSONPParameters="";for(var key in $that._parameters){if(count==0){JSONPParameters+='"'+key+'"'+': "'+$that._parameters[key]+'"'}else{JSONPParameters+=', '+'"'+key+'"'+': "'+$that._parameters[key]+'"'}count=count+1}postData=$.parseJSON("{ "+JSONPParameters+" }")}$.ajax({type:requestType,url:moreUrl,dataType:dataType,jsonpCallback:JSONPCallback,data:postData,success:function(data){more=data;if(typeof data==='object'){}else{try{more=$.parseJSON(data)}catch(err){$that._triggerEvent("error","_load",err.message);$("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false});return false}}try{var count=more.data[0].count;var html="";var json="";var template="";var templateId="";var templateType="";var templatePrecompiled=false;var mainElementSelector="";var singleItemElementSelector="";var bottomElementSelector="";var $bottomElement="";if(count>0){mainElementSelector=$that._selectors.main;singleItemElementSelector=$that._selectors.single;bottomElementSelector=$that._selectors.bottom;$bottomElement=$that._getBottomElement(mainElementSelector,bottomElementSelector);if((typeof more.data[0].html!='undefined')&&(more.data[0].html!='')){html=more.data[0].html;if($bottomElement){$(singleItemElementSelector).last().before(html)}else{$(mainElementSelector).append(html)}}else{if($that._instances[$that._settings.pageId]){if((typeof $that._instances[$that._settings.pageId]['settings'].templateId!='undefined')&&($that._instances[$that._settings.pageId]['settings'].templateId!='')){templateId=$that._instances[$that._settings.pageId]['settings'].templateId;if((typeof $that._instances[$that._settings.pageId]['settings'].templateType!='undefined')&&($that._instances[$that._settings.pageId]['settings'].templateType!='')){templateType=$that._instances[$that._settings.pageId]['settings'].templateType}if((typeof $that._instances[$that._settings.pageId]['settings'].template!='undefined')&&($that._instances[$that._settings.pageId]['settings'].template!='')){template=$that._instances[$that._settings.pageId]['settings'].template}}templatePrecompiled=$that._instances[$that._settings.pageId]['settings'].templatePrecompiled}else{if((typeof $that._settings.templateId!='undefined')&&($that._settings.templateId!='')){templateId=$that._settings.templateId;if((typeof $that._settings.templateType!='undefined')&&($that._settings.templateType!='')){templateType=$that._settings.templateType}if((typeof $that._settings.template!='undefined')&&($that._settings.template!='')){template=$that._settings.template}}templatePrecompiled=$that._settings.templatePrecompiled}if((templateType!=="")&&(templateId!=="")&&(template!=="")){if(templateType==="json2html"){json=more.data[0].json;if($bottomElement){$bottomElement.remove()}$(mainElementSelector).json2html(json,template);if($bottomElement){$(singleItemElementSelector).last().append($bottomElement)}}else{json=more.data[0];switch(templateType){case'handlebars':if(templatePrecompiled){template=Handlebars.templates[templateId+'.tmpl'];html=template(json)}else{template=Handlebars.compile(template);html=template(json)}break;case'icanhaz':ich.addTemplate("listitem",template);html=ich.listitem(json,true);ich.clearAll();break;case'dust':if(templatePrecompiled){dust.render(templateId,json,function(err,result){html=result})}else{dust.loadSource(template);dust.render(templateId,json,function(err,result){html=result})}break;case'dot':template=doT.template(template);html=template(json);break;default:break}if($bottomElement){$(singleItemElementSelector).last().before(html)}else{$(mainElementSelector).append(html)}}}else{}}$(mainElementSelector).listview('refresh');var singleItemHeight=0;count=parseInt(count);if($that._instances[$that._settings.pageId]){var totalHeight=$that._instances[$that._settings.pageId]['settings'].totalHeight;if(typeof $that._instances[$that._settings.pageId]['settings'].singleItemHeight!=='undefined'){singleItemHeight=$that._instances[$that._settings.pageId]['settings'].singleItemHeight}else{singleItemHeight=$(singleItemElementSelector).first().next().height();$that._instances[$that._settings.pageId]['settings'].singleItemHeight=singleItemHeight}$that._instances[$that._settings.pageId]['settings'].totalHeight=(totalHeight+(singleItemHeight*count))}else{if(typeof $that._settings.singleItemHeight!=='undefined'){singleItemHeight=$that._settings.singleItemHeight}else{singleItemHeight=$(singleItemElementSelector).first().next().height();$that._settings.singleItemHeight=singleItemHeight}$that._settings.totalHeight=($that._settings.totalHeight+($that._settings.singleItemHeight*count))}$that._instances[$that._settings.pageId]['options'].retrieved+=count;if((count<$that.options.retrieve)||($that.options.retrieve=="all")){$that._widgetState.done=true;$that._triggerEvent("alldone","_load")}}else{$that._widgetState.done=true;$that._triggerEvent("alldone","_load")}$("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false});$that._triggerEvent("doneloading","_load")}catch(err){$that._triggerEvent("error","_load",err.message);$("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false});return false}},error:function(msg){$that._triggerEvent("error","_load",msg);$("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false})},complete:function(msg){}})})}}},timeout)}else{if(this._widgetState.done){$that._triggerEvent("alldone","_load")}else if(this._widgetState.busy){$that._triggerEvent("busy","_load")}else{}}}else{$("#"+this._settings.progressDivId).hide(250,function(){if(typeof this._widgetState!='undefined'){this._widgetState.busy=false}})}}},_getBottomElement:function(mainElementSelector,bottomElementSelector){var $bottomElement=$(mainElementSelector).last().find(bottomElementSelector);switch($bottomElement.length){case 2:$bottomElement=$bottomElement.last();break;case 1:case 0:default:$bottomElement=null;break}if((typeof $bottomElement!='undefined')&&($bottomElement!=null)&&($bottomElement!='')&&($bottomElement!='null')){return $bottomElement}else{return false}},_handleMouseWheelEvent:function(){if((!this._mouseWheelEventJustFired)&&(!this._handleScrollStopJustFired)&&(!this._handleScrollStartJustFired)){this._mouseWheelEventJustFired=true;this._load(this.timeoutOptions.mousewheel);var $that=this;this._mouseWheelTimeoutId=setTimeout(function(){$that._mouseWheelEventJustFired=false},1000)}},_handleScrollStart:function(){if((!this._mouseWheelEventJustFired)&&(!this._handleScrollStopJustFired)&&(!this._handleScrollStartJustFired)){this._handleScrollStartJustFired=true;this._load(this.timeoutOptions.scrollstart);var $that=this;this._handleScrollStartTimeoutId=setTimeout(function(){$that._handleScrollStartJustFired=false},1200)}},_handleScrollStop:function(){if((!this._mouseWheelEventJustFired)&&(!this._handleScrollStopJustFired)&&(!this._handleScrollStartJustFired)){this._handleScrollStopJustFired=true;this._load(this.timeoutOptions.scrollstop);var $that=this;this._handleScrollStopTimeoutId=setTimeout(function(){$that._handleScrollStopJustFired=false},1200)}},loadMore:function(timeout){if(timeout===0){this._load(this.timeoutOptions.immediately)}else{this._load(this.timeoutOptions.scrolldown)}},_setOption:function(key,value){if(this._instances[this._settings.pageId]){if(this._instances[this._settings.pageId]['options'][key]){this._instances[this._settings.pageId]['options'][key]=value}}$.Widget.prototype._setOption.apply(this,arguments)},refresh:function(what){if(what=='parameters'){if(typeof this.options!='undefined'){for(var key in this._parameters){if(typeof this.options[key]!='undefined'){this._parameters[key]=this.options[key]}}}}else if(what=='parameter'){var key=arguments[1];if(typeof this.options[key]!='undefined'){this._parameters[key]=this.options[key]}}else{}var newParameters=JSON.stringify(this._parameters);this._parameters=$.parseJSON(newParameters)},reInitialize:function(options,settings,parameters,selectors){options=""||options;settings=""||settings;parameters=""||parameters;selectors=""||selectors;this._initialize(options,settings,parameters,selectors)},reset:function(pageId){var $that=this;$.ajax({type:"POST",url:$that._settings.clearUrl,async:true,data:"section="+pageId,success:function(msg){if(parseInt(msg)){$that.options.retrieved=$that._defaultOptions.retrieved;$that._widgetState.done=false;if(typeof $that._instances[pageId]!='undefined'){delete $that._instances[pageId]}var announcement="All session variables for the '"+pageId+"' page and the lazyloader instance variables have been cleared.";$that._triggerEvent("reset","reset",announcement)}},error:function(msg){$that._triggerEvent("error","reset",msg);$("#"+$that._settings.progressDivId).hide(250,function(){$that._widgetState.busy=false})}})},resetAll:function(){var $that=this;$.ajax({type:"POST",url:$that._settings.clearUrl,async:true,data:"",success:function(msg){if(parseInt(msg)){for(pageId in $that._instances){delete $that._instances[pageId]}$that.options.retrieved=$that._defaultOptions.retrieved;$that._widgetState.done=false;$that._widgetState.busy=false;var announcement="All session variables for all pages currently being tracked by the lazyloader have been cleared.";$that._triggerEvent("resetall","resetAll",announcement)}}})},_triggerEvent:function(type,caller,message){message=message||"";switch(type){case'error':case'resetall':this._trigger(type,{"type":"lazyloader"+type,"function":caller,"message":message,"settings":this._settings,"options":this.options,"parameters":this._parameters});break;default:this._trigger(type,{"type":"lazyloader"+type,"function":caller,"message":message,"pageId":this._settings.pageId,"mainId":this._settings.mainId,"loaded":this.options.retrieved});break}}});$(document).bind("pagecreate create",function(e){$(e.target).enhanceWithin()})})(jQuery);